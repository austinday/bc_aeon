FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install Python and basic tools
RUN apt-get update && apt-get install -y \
    python3.10 python3.10-dev python3.10-venv \
    git curl wget \
    libgl1-mesa-glx libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Set up Python alias
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10 && \
    ln -sf /usr/bin/python3.10 /usr/bin/python3 && \
    ln -sf /usr/bin/python3.10 /usr/bin/python

# Install PyTorch (CUDA 12.1)
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# Install Vision Dependencies (CACHE BUSTER: 2026-01-24)
# diffusers: For Image Generation
# transformers>=4.46.0: REQUIRED for Qwen2-VL support
# qwen-vl-utils: REQUIRED for Qwen2-VL
# bitsandbytes: For 4-bit quantization (saving VRAM)
# accelerate: For device mapping
# pillow, numpy: Core deps
RUN pip install --no-cache-dir \
    "diffusers>=0.30.0" \
    "transformers>=4.46.0" \
    "accelerate>=0.26.0" \
    "qwen-vl-utils" \
    "bitsandbytes" \
    "protobuf" \
    "sentencepiece" \
    "pillow" \
    "numpy<2.0"

WORKDIR /workspace
